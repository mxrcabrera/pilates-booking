generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String              @id @default(uuid())
  email                   String              @unique
  nombre                  String
  telefono                String?
  genero                  String              @default("F") @map("genero")
  password                String?
  emailVerified           DateTime?           @map("email_verified")
  image                   String?
  role                    UserRole            @default(PROFESOR)
  plan                    PlanType            @default(FREE) @map("plan")
  trialEndsAt             DateTime?           @map("trial_ends_at")
  planStartedAt           DateTime?           @map("plan_started_at")
  horasAnticipacionMinima Int                 @default(1) @map("horas_anticipacion_minima")
  maxAlumnosPorClase      Int                 @default(4) @map("max_alumnos_por_clase")
  horarioMananaInicio     String              @default("08:00") @map("horario_manana_inicio")
  horarioMananaFin        String              @default("14:00") @map("horario_manana_fin")
  turnoMananaActivo       Boolean             @default(true) @map("turno_manana_activo")
  horarioTardeInicio      String              @default("17:00") @map("horario_tarde_inicio")
  horarioTardeFin         String              @default("22:00") @map("horario_tarde_fin")
  turnoTardeActivo        Boolean             @default(true) @map("turno_tarde_activo")
  syncGoogleCalendar      Boolean             @default(false) @map("sync_google_calendar")
  googleCalendarId        String?             @map("google_calendar_id")
  precioPorClase          Decimal             @default(0) @map("precio_por_clase") @db.Decimal(10, 2)
  createdAt               DateTime            @default(now()) @map("created_at")
  accounts                Account[]
  alumnos                 Alumno[]
  alumnoProfile           Alumno?             @relation("AlumnoUser")
  clases                  Clase[]
  horariosDisponibles     HorarioDisponible[]
  notificacionesRecibidas Notificacion[]
  packs                   Pack[]
  sessions                Session[]
  pagosRecibidos          Pago[]
  listaEspera             ListaEspera[]
  estudios                EstudioMiembro[]

  @@map("users")
}

model Pack {
  id              String    @id @default(uuid())
  profesorId      String    @map("profesor_id")
  estudioId       String?   @map("estudio_id")
  nombre          String
  clasesPorSemana Int       @map("clases_por_semana")
  precio          Decimal   @db.Decimal(10, 2)
  createdAt       DateTime  @default(now()) @map("created_at")
  deletedAt       DateTime? @map("deleted_at")
  profesor        User      @relation(fields: [profesorId], references: [id], onDelete: Cascade)
  estudio         Estudio?  @relation(fields: [estudioId], references: [id])

  @@map("packs")
}

model Alumno {
  id                  String    @id @default(uuid())
  profesorId          String    @map("profesor_id")
  estudioId           String?   @map("estudio_id")
  userId              String?   @unique @map("user_id")
  nombre              String
  email               String
  telefono            String
  cumpleanos          DateTime? @map("cumpleanos") @db.Date
  patologias          String?   @map("patologias")
  packType            String    @map("pack_type")
  clasesPorMes        Int?      @map("clases_por_mes")
  precio              Decimal   @db.Decimal(10, 2)
  estaActivo          Boolean   @default(true) @map("esta_activa")
  estaPausada         Boolean   @default(false) @map("esta_pausada")
  syncGoogleCalendar  Boolean   @default(false) @map("sync_google_calendar")
  googleCalendarId    String?   @map("google_calendar_id")
  createdAt           DateTime  @default(now()) @map("created_at")
  deletedAt           DateTime? @map("deleted_at")
  genero              String    @default("F") @map("genero")
  consentimientoTutor Boolean   @default(false) @map("consentimiento_tutor")
  diaInicioCiclo      Int       @default(1) @map("dia_inicio_ciclo")
  saldoAFavor         Decimal   @default(0) @db.Decimal(10, 2) @map("saldo_a_favor")
  profesor            User      @relation(fields: [profesorId], references: [id], onDelete: Cascade)
  estudio             Estudio?  @relation(fields: [estudioId], references: [id])
  user                User?     @relation("AlumnoUser", fields: [userId], references: [id])
  clases              Clase[]
  pagos               Pago[]
  listaEspera         ListaEspera[]

  @@map("alumnos")
}

model HorarioDisponible {
  id         String    @id @default(uuid())
  profesorId String    @map("profesor_id")
  estudioId  String?   @map("estudio_id")
  diaSemana  Int       @map("dia_semana")
  horaInicio String    @map("hora_inicio")
  horaFin    String    @map("hora_fin")
  esManiana  Boolean   @map("es_maniana")
  estaActivo Boolean   @default(true) @map("esta_activo")
  createdAt  DateTime  @default(now()) @map("created_at")
  deletedAt  DateTime? @map("deleted_at")
  profesor   User      @relation(fields: [profesorId], references: [id], onDelete: Cascade)
  estudio    Estudio?  @relation(fields: [estudioId], references: [id])

  @@map("horarios_disponibles")
}

model Clase {
  id                String    @id @default(uuid())
  profesorId        String    @map("profesor_id")
  estudioId         String?   @map("estudio_id")
  alumnoId          String?   @map("alumno_id")
  fecha             DateTime  @db.Date
  horaInicio        String    @map("hora_inicio")
  horaRecurrente    String?   @map("hora_recurrente")
  esRecurrente      Boolean   @default(false) @map("es_recurrente")
  frecuenciaSemanal Int?      @map("frecuencia_semanal")
  diasSemana        Int[]     @map("dias_semana")
  estado            String    @default("reservada") // reservada, completada, cancelada
  asistencia        String    @default("pendiente") // pendiente, presente, ausente
  esClasePrueba     Boolean   @default(false) @map("es_clase_prueba")
  googleEventId     String?   @map("google_event_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  deletedAt         DateTime? @map("deleted_at")
  alumno            Alumno?        @relation(fields: [alumnoId], references: [id])
  profesor          User           @relation(fields: [profesorId], references: [id], onDelete: Cascade)
  estudio           Estudio?       @relation(fields: [estudioId], references: [id])
  notificaciones    Notificacion[]

  @@map("clases")
}

model Pago {
  id                 String    @id @default(uuid())
  alumnoId           String    @map("alumno_id")
  profesorId         String?   @map("profesor_id")
  estudioId          String?   @map("estudio_id")
  monto              Decimal   @db.Decimal(10, 2)
  fechaPago          DateTime? @map("fecha_pago") @db.Date
  fechaVencimiento   DateTime  @map("fecha_vencimiento") @db.Date
  estado             String    @default("pendiente")
  mesCorrespondiente String    @map("mes_correspondiente")
  tipoPago           String    @default("mensual") @map("tipo_pago") // "mensual" (pack) o "clase"
  clasesEsperadas    Int?      @map("clases_esperadas") // Clases que debe hacer en el mes (del pack)
  createdAt          DateTime  @default(now()) @map("created_at")
  deletedAt          DateTime? @map("deleted_at")
  alumno             Alumno    @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  profesor           User?     @relation(fields: [profesorId], references: [id])
  estudio            Estudio?  @relation(fields: [estudioId], references: [id])

  @@map("pagos")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}


model Notificacion {
  id           String           @id @default(uuid())
  userId       String           @map("user_id")
  tipo         NotificationType
  titulo       String
  mensaje      String
  leida        Boolean          @default(false)
  claseId      String?          @map("clase_id")
  emailEnviado Boolean          @default(false) @map("email_enviado")
  createdAt    DateTime         @default(now()) @map("created_at")
  clase        Clase?           @relation(fields: [claseId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

enum UserRole {
  PROFESOR
  ALUMNO
}

enum PlanType {
  FREE
  STARTER
  PRO
  ESTUDIO
}

enum EstudioRol {
  OWNER      // Due침o - acceso total, facturaci칩n
  ADMIN      // Admin - todo excepto facturaci칩n
  INSTRUCTOR // Instructor - gestionar sus propias clases
  VIEWER     // Solo lectura
}

model Estudio {
  id                  String            @id @default(uuid())
  nombre              String
  slug                String            @unique
  plan                PlanType          @default(FREE)
  trialEndsAt         DateTime?         @map("trial_ends_at")
  planStartedAt       DateTime?         @map("plan_started_at")

  // Configuraci칩n del estudio
  horasAnticipacionMinima Int           @default(1) @map("horas_anticipacion_minima")
  maxAlumnosPorClase      Int           @default(4) @map("max_alumnos_por_clase")
  horarioMananaInicio     String        @default("08:00") @map("horario_manana_inicio")
  horarioMananaFin        String        @default("14:00") @map("horario_manana_fin")
  turnoMananaActivo       Boolean       @default(true) @map("turno_manana_activo")
  horarioTardeInicio      String        @default("17:00") @map("horario_tarde_inicio")
  horarioTardeFin         String        @default("22:00") @map("horario_tarde_fin")
  turnoTardeActivo        Boolean       @default(true) @map("turno_tarde_activo")
  precioPorClase          Decimal       @default(0) @map("precio_por_clase") @db.Decimal(10, 2)

  // Google Calendar
  syncGoogleCalendar  Boolean           @default(false) @map("sync_google_calendar")
  googleCalendarId    String?           @map("google_calendar_id")

  createdAt           DateTime          @default(now()) @map("created_at")

  // Relaciones
  miembros            EstudioMiembro[]
  alumnos             Alumno[]
  clases              Clase[]
  pagos               Pago[]
  horariosDisponibles HorarioDisponible[]
  packs               Pack[]
  listaEspera         ListaEspera[]

  @@map("estudios")
}

model EstudioMiembro {
  id        String      @id @default(uuid())
  estudioId String      @map("estudio_id")
  userId    String      @map("user_id")
  rol       EstudioRol  @default(INSTRUCTOR)
  createdAt DateTime    @default(now()) @map("created_at")

  estudio   Estudio     @relation(fields: [estudioId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([estudioId, userId])
  @@map("estudio_miembros")
}

model ListaEspera {
  id          String    @id @default(uuid())
  alumnoId    String    @map("alumno_id")
  profesorId  String    @map("profesor_id")
  estudioId   String?   @map("estudio_id")
  fecha       DateTime  @db.Date
  horaInicio  String    @map("hora_inicio")
  posicion    Int       @default(1) @map("posicion")
  estado      String    @default("esperando") // esperando, notificado, confirmado, expirado, cancelado
  notificadoEn DateTime? @map("notificado_en")
  expiraEn    DateTime? @map("expira_en")
  createdAt   DateTime  @default(now()) @map("created_at")
  alumno      Alumno    @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  profesor    User      @relation(fields: [profesorId], references: [id], onDelete: Cascade)
  estudio     Estudio?  @relation(fields: [estudioId], references: [id])

  @@unique([alumnoId, profesorId, fecha, horaInicio])
  @@map("lista_espera")
}

enum NotificationType {
  CLASE_NUEVA
  CLASE_MODIFICADA
  CLASE_CANCELADA
  RECORDATORIO_CLASE
  LUGAR_DISPONIBLE
}
